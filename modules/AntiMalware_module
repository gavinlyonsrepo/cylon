#!/bin/bash
#module containing functions called from cylon package
#SystemSecFunc and AntiMalwareFunc

#FUNCTION HEADER
# NAME :  SystemSecFunc
# DESCRIPTION: display security menu called from main menu
function SystemSecFunc
{
	clear
	while true; do
	msgFunc blue "System Security Menu options:-"
	optionsSS=("$(msgFunc checkpac ccrypt NOMES)" "$(msgFunc checkpac clamav NOMES)" "$(msgFunc checkpac rkhunter NOMES)" 
	"$(msgFunc checkpac lynis NOMES)" "Password generator" "Return")
			select choiceSS in "${optionsSS[@]}"
			do
			case "$choiceSS" in 
			 "${optionsSS[0]}") # ccrypt - encrypt and decrypt files 
				ccryptFunc
			 ;;
			 "${optionsSS[1]}") #Anti-virus clamav
				AntiMalwareFunc "CLAMAV"
			 ;;
			 "${optionsSS[2]}") #rootkit hunter 
				AntiMalwareFunc "RKHUNTER"
			 ;;
			 "${optionsSS[3]}") # Lynis - System and security auditing tool
				AntiMalwareFunc "LYNIS"
			 ;;
			 "${optionsSS[4]}") #Password generator
				msgFunc dir "-SYSSECURITY"
				msgFunc green "Random Password generator"
				msgFunc norm "Enter length:-"
				read -r mylength
				if [ -z "$mylength" ]; then
					mylength=50
				fi
				echo -n "$(< /dev/urandom tr -dc "_*?#!A-Z-a-z-0-9" | head -c"${1:-$mylength}";)"	> pg	  
				msgFunc green "Done!"
			 ;;
			 
			 *)  #exit  
				clear
				return
			;;
			esac
			break
			done
done
}

#FUNCTION HEADER# NAME :  AntiMalwareFunc 
# DESCRIPTION: Function for ROOTKIT HUNTER software
#anti virus with clamscan and lynis security audit
# INPUTS:  $1  CLAMAV or "RKHUNTER" or lynis
# PROCESS : clamav and rkhunter full scans
#NOTES :    needs clamav,lynis and rkhunter installed  

function AntiMalwareFunc
{
#clamav section
	if [ "$1" = "CLAMAV" ]
				then
            #check clamav is installed
            
            if ! msgFunc checkpac clamav
				then
				msgFunc anykey 
				return
			fi
			# update clamscan virus definitions:
			msgFunc green "Updating clamavscan Databases"
			sudo freshclam
			msgFunc green "Done!"
			msgFunc green "Scanning with Clamav$"
			# scan entire system
			msgFunc dir "-CLAMAVINFO"
			sudo clamscan -l clamavlogfile --recursive=yes --infected --exclude-dir='^/sys|^/proc|^/dev|^/lib|^/bin|^/sbin' /
			msgFunc green "Done!"			
			return
	fi
			
#Rootkitsection
	if [ "$1" = "RKHUNTER" ]
	then
		#check rkhunter is installed
		
		if ! msgFunc checkpac rkhunter
		then
			msgFunc anykey 
		return
		fi
		msgFunc green "Checking rkhunter data files"
		sudo rkhunter --update
		msgFunc green "Done!"
		msgFunc green "Fill the file properties database"
		sudo rkhunter --propupd
		msgFunc green "Done!"
		msgFunc green "Running Rootkit hunter"
		sudo rkhunter --check
		msgFunc green "Done!"
		msgFunc anykey
		return
	fi
	
#lynis section
	if [ "$1" = "LYNIS" ]
	then
		#check lynis is installed
		if ! msgFunc checkpac lynis
		then
			msgFunc anykey 
		return
		fi
		msgFunc green "Lynis - System and security auditing tool"
		 sudo  lynis audit system
		 msgFunc norm "Entire logfile at /var/log/lynis.log"
		 msgFunc norm  "Summary of logfile at:-"
		 msgFunc dir "-LYNISINFO"
		 {
		 echo "Warnings" 
		 sudo grep Warning /var/log/lynis.log 
		 echo "Suggestions" 
		 sudo grep Suggestion /var/log/lynis.log  
		 } >> lynisinfo
		msgFunc anykey
		msgFunc green "Done!"
	fi
	
}

